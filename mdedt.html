<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor - „ÅØ„Å¶„Å™Blog‰ªïÊßò</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }

        .editor-panel, .preview-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .save-status {
            font-size: 12px;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: normal;
        }

        .save-status.saved {
            background: #d4edda;
            color: #155724;
        }

        .save-status.unsaved {
            background: #f8d7da;
            color: #721c24;
        }

        #markdown-input {
            flex: 1;
            border: none;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            border-radius: 0 0 8px 8px;
        }

        #preview-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
        }

        .controls {
            background: white;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .file-input {
            display: none;
        }

        .drag-drop-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .drag-drop-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .image-manager {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .image-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .image-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .image-item:hover {
            background: #e3f2fd;
        }

        .image-item .remove-btn {
            margin-left: 0.5rem;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #666;
            font-style: italic;
        }

        /* Markdown „Çπ„Çø„Ç§„É´ */
        #preview-content h1, #preview-content h2, #preview-content h3,
        #preview-content h4, #preview-content h5, #preview-content h6 {
            margin: 1rem 0 0.5rem 0;
            color: #333;
        }

        #preview-content h1 { font-size: 2rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        #preview-content h2 { font-size: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.3rem; }
        #preview-content h3 { font-size: 1.3rem; }
        #preview-content h4 { font-size: 1.1rem; }

        #preview-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        #preview-content code {
            background: #f1f3f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        #preview-content pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            position: relative;
        }

        #preview-content pre code {
            background: none;
            padding: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Prism.js „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #708090;
        }

        .token.punctuation {
            color: #999;
        }

        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: #905;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: #690;
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: #9a6e3a;
        }

        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: #07a;
        }

        .token.function,
        .token.class-name {
            color: #DD4A68;
        }

        .token.regex,
        .token.important,
        .token.variable {
            color: #e90;
        }

        #preview-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #666;
            font-style: italic;
        }

        #preview-content ul, #preview-content ol {
            margin: 0.5rem 0;
            padding-left: 2rem;
        }

        #preview-content li {
            margin: 0.25rem 0;
        }

        #preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 0.5rem 0;
        }

        #preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        #preview-content th, #preview-content td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }

        #preview-content th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .hatena-syntax {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìù Markdown Editor - „ÅØ„Å¶„Å™Blog‰ªïÊßò</h1>
    </div>

    <div class="main-container">
        <div class="editor-panel">
            <div class="panel-header">
                <span>üìù Markdown Editor</span>
                <span id="save-status" class="save-status saved">‰øùÂ≠òÊ∏à„Åø</span>
            </div>
            <textarea id="markdown-input" placeholder="„Åì„Åì„Å´Markdown„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...

# „Çµ„É≥„Éó„É´
„Åì„Çå„ÅØ**Â§™Â≠ó**„Åß„ÄÅ„Åì„Çå„ÅØ*Êñú‰Ωì*„Åß„Åô„ÄÇ

## „É™„Çπ„Éà
- È†ÖÁõÆ1
- È†ÖÁõÆ2
  - „Çµ„ÉñÈ†ÖÁõÆ

## „Ç≥„Éº„Éâ
```javascript
console.log('Hello World!');
```

## „ÅØ„Å¶„Å™Ë®òÊ≥ï
[f:id:sample:20200101120000j:plain]

## ÂºïÁî®
> „Åì„Çå„ÅØÂºïÁî®Êñá„Åß„Åô„ÄÇ

## „ÉÜ„Éº„Éñ„É´
| Âàó1 | Âàó2 |
|-----|-----|
| „Éá„Éº„Çø1 | „Éá„Éº„Çø2 |

## ÁîªÂÉè
![sample-image](sample-image.jpg)"></textarea>
            <div class="image-manager">
                <div style="font-size: 12px; margin-bottom: 0.5rem; color: #666;">üì∑ ÁîªÂÉèÁÆ°ÁêÜ („ÇØ„É™„ÉÉ„ÇØ„ÅßÊåøÂÖ•)</div>
                <div class="loading-indicator" id="loading-indicator">üîÑ ÁîªÂÉè„ÇíÂá¶ÁêÜ‰∏≠...</div>
                <div id="image-list" class="image-list">
                    <!-- ÁîªÂÉè„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                </div>
            </div>
        </div>

        <div class="preview-panel">
            <div class="panel-header">
                üëÅÔ∏è Preview
            </div>
            <div id="preview-content">
                <div class="drag-drop-area" id="drag-drop-area">
                    <p>üìÑ „Éó„É¨„Éì„É•„Éº„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    <p>„Åæ„Åü„ÅØÁîªÂÉè„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="updatePreview()">
            üëÅÔ∏è „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
        </button>
        <button class="btn btn-secondary" onclick="openFile()">
            üìÅ „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè
        </button>
        <button class="btn btn-success" onclick="downloadMarkdown()">
            üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        </button>
        <button class="btn btn-secondary" onclick="document.getElementById('image-input').click()">
            üñºÔ∏è ÁîªÂÉèËøΩÂä†
        </button>
        <button class="btn btn-secondary" onclick="clearEditor()">
            üóëÔ∏è „ÇØ„É™„Ç¢
        </button>
    </div>

    <input type="file" id="file-input" class="file-input" accept=".md,.txt" onchange="loadFile(event)">
    <input type="file" id="image-input" class="file-input" accept="image/*" onchange="handleImageUpload(event)">

    <script>
        // ÁîªÂÉè„Çπ„Éà„É¨„Éº„Ç∏ÔºàÂèÇÁÖßÂêç -> Base64„Éá„Éº„ÇøÔºâ
        const imageStorage = new Map();
        let imageCounter = 1;
        
        // ‰øùÂ≠òÁä∂ÊÖãÁÆ°ÁêÜ
        let hasUnsavedChanges = false;
        let initialContent = '';
        
        // Marked„ÅÆË®≠ÂÆö
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // ‰øùÂ≠òÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateSaveStatus(saved = false) {
            const statusElement = document.getElementById('save-status');
            if (saved) {
                statusElement.textContent = '‰øùÂ≠òÊ∏à„Åø';
                statusElement.className = 'save-status saved';
                hasUnsavedChanges = false;
            } else {
                statusElement.textContent = 'Êú™‰øùÂ≠ò';
                statusElement.className = 'save-status unsaved';
                hasUnsavedChanges = true;
            }
        }

        // Â§âÊõ¥Ê§úÁü•
        function checkForChanges() {
            const currentContent = document.getElementById('markdown-input').value;
            if (currentContent !== initialContent) {
                updateSaveStatus(false);
            } else {
                updateSaveStatus(true);
            }
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±Ââç„ÅÆË≠¶Âëä
        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges) {
                const message = 'Á∑®ÈõÜ‰∏≠„ÅÆ„Éá„Éº„Çø„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÈõ¢„Çå„Çã„Å®Â§âÊõ¥ÂÜÖÂÆπ„ÅåÂ§±„Çè„Çå„Åæ„Åô„Åå„ÄÅ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });

        // ÁîªÂÉè„É™„Çπ„Éà„ÅÆÊõ¥Êñ∞
        function updateImageList() {
            const imageList = document.getElementById('image-list');
            imageList.innerHTML = '';
            
            imageStorage.forEach((base64Data, imageName) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <span onclick="insertImageReference('${imageName}')" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÊåøÂÖ•">üñºÔ∏è ${imageName}</span>
                    <span class="remove-btn" onclick="removeImage('${imageName}')" title="ÂâäÈô§">√ó</span>
                `;
                imageList.appendChild(imageItem);
            });
        }

        // Base64ÁîªÂÉè„ÇíMarkdown„Åã„ÇâÊäΩÂá∫„Åó„Å¶ÂèÇÁÖß„Ç∑„Çπ„ÉÜ„É†„Å´Â§âÊèõ
        function convertBase64ImagesToReferences(markdown) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';
            
            // Base64ÁîªÂÉè„ÅÆ„Éë„Çø„Éº„É≥„ÇíÊ§úÁ¥¢
            const base64ImageRegex = /!\[([^\]]*)\]\(data:image\/[^;]+;base64,[^)]+\)/g;
            let match;
            let processedMarkdown = markdown;
            let imageCount = 0;
            
            while ((match = base64ImageRegex.exec(markdown)) !== null) {
                const fullMatch = match[0];
                const altText = match[1] || `image-${imageCounter}`;
                const base64Data = fullMatch.match(/\(([^)]+)\)/)[1];
                
                // Êñ∞„Åó„ÅÑÂèÇÁÖßÂêç„ÇíÁîüÊàê
                const imageName = `loaded-image-${imageCounter++}-${altText.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                
                // ÁîªÂÉè„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                imageStorage.set(imageName, base64Data);
                
                // Markdown„ÅÆË©≤ÂΩìÈÉ®ÂàÜ„ÇíÂèÇÁÖßÂΩ¢Âºè„Å´ÁΩÆÊèõ
                processedMarkdown = processedMarkdown.replace(fullMatch, `![${altText}](${imageName})`);
                imageCount++;
            }
            
            // ÁîªÂÉè„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            updateImageList();
            loadingIndicator.style.display = 'none';
            
            if (imageCount > 0) {
                console.log(`${imageCount}ÂÄã„ÅÆÁîªÂÉè„ÇíÂèÇÁÖß„Ç∑„Çπ„ÉÜ„É†„Å´Â§âÊèõ„Åó„Åæ„Åó„Åü`);
            }
            
            return processedMarkdown;
        }

        // ÁîªÂÉèÂèÇÁÖß„ÅÆÊåøÂÖ•
        function insertImageReference(imageName) {
            const textarea = document.getElementById('markdown-input');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            const imageMarkdown = `![${imageName}](${imageName})`;
            
            textarea.value = textBefore + imageMarkdown + textAfter;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + imageMarkdown.length, cursorPos + imageMarkdown.length);
            checkForChanges();
        }

        // ÁîªÂÉè„ÅÆÂâäÈô§
        function removeImage(imageName) {
            if (confirm(`ÁîªÂÉè "${imageName}" „ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                imageStorage.delete(imageName);
                updateImageList();
                checkForChanges();
            }
        }

        // „ÅØ„Å¶„Å™Ë®òÊ≥ï„ÅÆÂá¶ÁêÜ
        function processHatenaSyntax(markdown) {
            // ÁîªÂÉèÂèÇÁÖß„ÇíBase64„Éá„Éº„Çø„Å´ÁΩÆÊèõ
            imageStorage.forEach((base64Data, imageName) => {
                const regex = new RegExp(`!\\[([^\\]]*)\\]\\(${imageName}\\)`, 'g');
                markdown = markdown.replace(regex, `![$1](${base64Data})`);
            });

            // [f:id:username:timestamp] ÂΩ¢Âºè„ÅÆÁîªÂÉèË®òÊ≥ï
            markdown = markdown.replace(/\[f:id:([^:]+):([^\]]+)\]/g, (match, username, timestamp) => {
                const imageKey = `hatena_${username}_${timestamp}`;
                if (imageStorage.has(imageKey)) {
                    return `![${match}](${imageStorage.get(imageKey)})`;
                }
                return `<div class="hatena-syntax">üì∑ „ÅØ„Å¶„Å™ÁîªÂÉè: ${match} (ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ)</div>`;
            });

            // [http://example.com:title] ÂΩ¢Âºè„ÅÆ„É™„É≥„ÇØË®òÊ≥ï
            markdown = markdown.replace(/\[(https?:\/\/[^\]]+):title\]/g, (match, url) => {
                return `[${url}](${url})`;
            });

            // [tex: Êï∞Âºè] Ë®òÊ≥ï
            markdown = markdown.replace(/\[tex:\s*([^\]]+)\]/g, (match, formula) => {
                return `<div class="hatena-syntax">üìê Êï∞Âºè: ${formula}</div>`;
            });

            // [:contents] ÁõÆÊ¨°Ë®òÊ≥ï
            markdown = markdown.replace(/\[:contents\]/g, '<div class="hatena-syntax">üìã ÁõÆÊ¨°„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>');

            return markdown;
        }

        // „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
        function updatePreview() {
            const markdownText = document.getElementById('markdown-input').value;
            const processedMarkdown = processHatenaSyntax(markdownText);
            
            try {
                const html = marked.parse(processedMarkdown);
                const cleanHtml = DOMPurify.sanitize(html);
                document.getElementById('preview-content').innerHTML = cleanHtml;
                
                // „Ç∑„É≥„Çø„ÉÉ„ÇØ„Çπ„Éè„Ç§„É©„Ç§„Éà„ÇíÈÅ©Áî®
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            } catch (error) {
                document.getElementById('preview-content').innerHTML = `<div style="color: red;">„Ç®„É©„Éº: \${error.message}</div>`;
            }
        }

        // „Éï„Ç°„Ç§„É´„ÇíÈñã„ÅèÔºàË≠¶Âëä‰ªò„ÅçÔºâ
        function openFile() {
            if (hasUnsavedChanges) {
                if (!confirm('ÁèæÂú®Á∑®ÈõÜ‰∏≠„ÅÆ„Éá„Éº„Çø„ÅåÂ§±„Çè„Çå„Åæ„Åô„Åå„ÄÅÊñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„ÇíÈñã„Åç„Åæ„Åô„ÅãÔºü')) {
                    return;
                }
            }
            document.getElementById('file-input').click();
        }

        // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÔºàBase64ÁîªÂÉè„ÅÆÂ§âÊèõÂá¶ÁêÜ„ÇíËøΩÂä†Ôºâ
        function loadFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let content = e.target.result;
                    
                    // Êó¢Â≠ò„ÅÆÁîªÂÉè„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                    imageStorage.clear();
                    
                    // Base64ÁîªÂÉè„ÇíÂèÇÁÖß„Ç∑„Çπ„ÉÜ„É†„Å´Â§âÊèõ
                    content = convertBase64ImagesToReferences(content);
                    
                    document.getElementById('markdown-input').value = content;
                    initialContent = content;
                    updateSaveStatus(true);
                    updatePreview();
                };
                reader.readAsText(file);
            }
        }

        // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàÁîªÂÉè„ÇÇÂê´„ÇÅ„Å¶Âá¶ÁêÜÔºâ
        function downloadMarkdown() {
            let content = document.getElementById('markdown-input').value;
            
            // ÁîªÂÉèÂèÇÁÖß„ÇíBase64„Éá„Éº„Çø„Å´ÁΩÆÊèõ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            imageStorage.forEach((base64Data, imageName) => {
                const regex = new RegExp(`!\\[([^\\]]*)\\]\\(${imageName}\\)`, 'g');
                content = content.replace(regex, `![$1](${base64Data})`);
            });
            
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂæå„ÅØ‰øùÂ≠òÊ∏à„Åø„Å®„Åø„Å™„Åô
            initialContent = document.getElementById('markdown-input').value;
            updateSaveStatus(true);
        }

        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    const imageName = `image-${imageCounter++}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                    
                    imageStorage.set(imageName, imageUrl);
                    updateImageList();
                    
                    // Ëá™ÂãïÁöÑ„Å´„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Å´ÊåøÂÖ•
                    insertImageReference(imageName);
                };
                reader.readAsDataURL(file);
            }
        }

        // „Ç®„Éá„Ç£„Çø„ÇØ„É™„Ç¢
        function clearEditor() {
            let confirmMessage = '„Ç®„Éá„Ç£„Çø„ÅÆÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü';
            if (hasUnsavedChanges) {
                confirmMessage = 'Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Ç®„Éá„Ç£„Çø„ÅÆÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü';
            }
            
            if (confirm(confirmMessage)) {
                document.getElementById('markdown-input').value = '';
                document.getElementById('preview-content').innerHTML = '<div class="drag-drop-area"><p>üìÑ „Éó„É¨„Éì„É•„Éº„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</p></div>';
                imageStorage.clear();
                updateImageList();
                initialContent = '';
                updateSaveStatus(true);
            }
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ
        const dragDropArea = document.getElementById('preview-content');

        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropArea.classList.add('dragover');
        });

        dragDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
        });

        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        const imageName = `dropped-${imageCounter++}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                        
                        imageStorage.set(imageName, imageUrl);
                        updateImageList();
                        
                        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÊú´Â∞æ„Å´ËøΩÂä†
                        const textarea = document.getElementById('markdown-input');
                        const imageMarkdown = `\n![${file.name}](${imageName})\n`;
                        textarea.value += imageMarkdown;
                        textarea.focus();
                        checkForChanges();
                    };
                    reader.readAsDataURL(file);
                } else if (file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                    if (hasUnsavedChanges) {
                        if (!confirm('ÁèæÂú®Á∑®ÈõÜ‰∏≠„ÅÆ„Éá„Éº„Çø„ÅåÂ§±„Çè„Çå„Åæ„Åô„Åå„ÄÅÊñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´„ÇíÈñã„Åç„Åæ„Åô„ÅãÔºü')) {
                            return;
                        }
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let content = e.target.result;
                        
                        // Êó¢Â≠ò„ÅÆÁîªÂÉè„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                        imageStorage.clear();
                        
                        // Base64ÁîªÂÉè„ÇíÂèÇÁÖß„Ç∑„Çπ„ÉÜ„É†„Å´Â§âÊèõ
                        content = convertBase64ImagesToReferences(content);
                        
                        document.getElementById('markdown-input').value = content;
                        initialContent = content;
                        updateSaveStatus(true);
                        updatePreview();
                    };
                    reader.readAsText(file);
                }
            });
        });

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'p':
                        e.preventDefault();
                        updatePreview();
                        break;
                    case 's':
                        e.preventDefault();
                        downloadMarkdown();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFile();
                        break;
                }
            }
        });

        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ
        document.getElementById('markdown-input').addEventListener('input', () => {
            checkForChanges();
            
            // „É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„ÉºÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(updatePreview, 1000);
        });

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            initialContent = document.getElementById('markdown-input').value;
            updatePreview();
            updateSaveStatus(true);
            updateImageList();
        });
    </script>
</body>
</html>