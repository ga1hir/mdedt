<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor - ã¯ã¦ãªBlogä»•æ§˜</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }

        .editor-panel, .preview-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .save-status {
            font-size: 12px;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: normal;
        }

        .save-status.saved {
            background: #d4edda;
            color: #155724;
        }

        .save-status.unsaved {
            background: #f8d7da;
            color: #721c24;
        }

        #markdown-input {
            flex: 1;
            border: none;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            border-radius: 0 0 8px 8px;
        }

        #preview-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
        }

        .controls {
            background: white;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .file-input {
            display: none;
        }

        .drag-drop-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .drag-drop-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .image-manager {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .image-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .image-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .image-item:hover {
            background: #e3f2fd;
        }

        .image-item .remove-btn {
            margin-left: 0.5rem;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #666;
            font-style: italic;
        }

        /* Markdown ã‚¹ã‚¿ã‚¤ãƒ« */
        #preview-content h1, #preview-content h2, #preview-content h3,
        #preview-content h4, #preview-content h5, #preview-content h6 {
            margin: 1rem 0 0.5rem 0;
            color: #333;
        }

        #preview-content h1 { font-size: 2rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
        #preview-content h2 { font-size: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.3rem; }
        #preview-content h3 { font-size: 1.3rem; }
        #preview-content h4 { font-size: 1.1rem; }

        #preview-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        #preview-content code {
            background: #f1f3f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        #preview-content pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            position: relative;
        }

        #preview-content pre code {
            background: none;
            padding: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Prism.js ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            color: #708090;
        }

        .token.punctuation {
            color: #999;
        }

        .token.property,
        .token.tag,
        .token.boolean,
        .token.number,
        .token.constant,
        .token.symbol,
        .token.deleted {
            color: #905;
        }

        .token.selector,
        .token.attr-name,
        .token.string,
        .token.char,
        .token.builtin,
        .token.inserted {
            color: #690;
        }

        .token.operator,
        .token.entity,
        .token.url,
        .language-css .token.string,
        .style .token.string {
            color: #9a6e3a;
        }

        .token.atrule,
        .token.attr-value,
        .token.keyword {
            color: #07a;
        }

        .token.function,
        .token.class-name {
            color: #DD4A68;
        }

        .token.regex,
        .token.important,
        .token.variable {
            color: #e90;
        }

        #preview-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #666;
            font-style: italic;
        }

        #preview-content ul, #preview-content ol {
            margin: 0.5rem 0;
            padding-left: 2rem;
        }

        #preview-content li {
            margin: 0.25rem 0;
        }

        #preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 0.5rem 0;
        }

        #preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        #preview-content th, #preview-content td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }

        #preview-content th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .hatena-syntax {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ Markdown Editor - ã¯ã¦ãªBlogä»•æ§˜</h1>
    </div>

    <div class="main-container">
        <div class="editor-panel">
            <div class="panel-header">
                <span>ğŸ“ Markdown Editor</span>
                <span id="save-status" class="save-status saved">ä¿å­˜æ¸ˆã¿</span>
            </div>
            <textarea id="markdown-input" placeholder="ã“ã“ã«Markdownã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...

# ã‚µãƒ³ãƒ—ãƒ«
ã“ã‚Œã¯**å¤ªå­—**ã§ã€ã“ã‚Œã¯*æ–œä½“*ã§ã™ã€‚

## ãƒªã‚¹ãƒˆ
- é …ç›®1
- é …ç›®2
  - ã‚µãƒ–é …ç›®

## ã‚³ãƒ¼ãƒ‰
```javascript
console.log('Hello World!');
```

## ã¯ã¦ãªè¨˜æ³•
[f:id:sample:20200101120000j:plain]

## å¼•ç”¨
> ã“ã‚Œã¯å¼•ç”¨æ–‡ã§ã™ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«
| åˆ—1 | åˆ—2 |
|-----|-----|
| ãƒ‡ãƒ¼ã‚¿1 | ãƒ‡ãƒ¼ã‚¿2 |

## ç”»åƒ
![sample-image](sample-image.jpg)"></textarea>
            <div class="image-manager">
                <div style="font-size: 12px; margin-bottom: 0.5rem; color: #666;">ğŸ“· ç”»åƒç®¡ç† (ã‚¯ãƒªãƒƒã‚¯ã§æŒ¿å…¥)</div>
                <div class="loading-indicator" id="loading-indicator">ğŸ”„ ç”»åƒã‚’å‡¦ç†ä¸­...</div>
                <div id="image-list" class="image-list">
                    <!-- ç”»åƒãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <div class="preview-panel">
            <div class="panel-header">
                ğŸ‘ï¸ Preview
            </div>
            <div id="preview-content">
                <div class="drag-drop-area" id="drag-drop-area">
                    <p>ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <p>ã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="updatePreview()">
            ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        </button>
        <button class="btn btn-secondary" onclick="openFile()">
            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
        </button>
        <button class="btn btn-success" onclick="downloadMarkdown()">
            ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
        <button class="btn btn-secondary" onclick="document.getElementById('image-input').click()">
            ğŸ–¼ï¸ ç”»åƒè¿½åŠ 
        </button>
        <button class="btn btn-secondary" onclick="clearEditor()">
            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
        </button>
    </div>

    <input type="file" id="file-input" class="file-input" accept=".md,.txt" onchange="loadFile(event)">
    <input type="file" id="image-input" class="file-input" accept="image/*" onchange="handleImageUpload(event)">

    <script>
        // ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆå‚ç…§å -> Base64ãƒ‡ãƒ¼ã‚¿ï¼‰
        const imageStorage = new Map();
        let imageCounter = 1;
        
        // ä¿å­˜çŠ¶æ…‹ç®¡ç†
        let hasUnsavedChanges = false;
        let initialContent = '';
        
        // Markedã®è¨­å®š
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // ä¿å­˜çŠ¶æ…‹ã®æ›´æ–°
        function updateSaveStatus(saved = false) {
            const statusElement = document.getElementById('save-status');
            if (saved) {
                statusElement.textContent = 'ä¿å­˜æ¸ˆã¿';
                statusElement.className = 'save-status saved';
                hasUnsavedChanges = false;
            } else {
                statusElement.textContent = 'æœªä¿å­˜';
                statusElement.className = 'save-status unsaved';
                hasUnsavedChanges = true;
            }
        }

        // å¤‰æ›´æ¤œçŸ¥
        function checkForChanges() {
            const currentContent = document.getElementById('markdown-input').value;
            if (currentContent !== initialContent) {
                updateSaveStatus(false);
            } else {
                updateSaveStatus(true);
            }
        }

        // ãƒšãƒ¼ã‚¸é›¢è„±å‰ã®è­¦å‘Š
        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges) {
                const message = 'ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨å¤‰æ›´å†…å®¹ãŒå¤±ã‚ã‚Œã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });

        // ç”»åƒãƒªã‚¹ãƒˆã®æ›´æ–°
        function updateImageList() {
            const imageList = document.getElementById('image-list');
            imageList.innerHTML = '';
            
            imageStorage.forEach((base64Data, imageName) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <span onclick="insertImageReference('${imageName}')" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦æŒ¿å…¥">ğŸ–¼ï¸ ${imageName}</span>
                    <span class="remove-btn" onclick="removeImage('${imageName}')" title="å‰Šé™¤">Ã—</span>
                `;
                imageList.appendChild(imageItem);
            });
        }

        // Base64ç”»åƒã‚’Markdownã‹ã‚‰æŠ½å‡ºã—ã¦å‚ç…§ã‚·ã‚¹ãƒ†ãƒ ã«å¤‰æ›
        function convertBase64ImagesToReferences(markdown) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';
            
            // Base64ç”»åƒã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
            const base64ImageRegex = /!\[([^\]]*)\]\(data:image\/[^;]+;base64,[^)]+\)/g;
            let match;
            let processedMarkdown = markdown;
            let imageCount = 0;
            
            while ((match = base64ImageRegex.exec(markdown)) !== null) {
                const fullMatch = match[0];
                const altText = match[1] || `image-${imageCounter}`;
                const base64Data = fullMatch.match(/\(([^)]+)\)/)[1];
                
                // æ–°ã—ã„å‚ç…§åã‚’ç”Ÿæˆ
                const imageName = `loaded-image-${imageCounter++}-${altText.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                
                // ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                imageStorage.set(imageName, base64Data);
                
                // Markdownã®è©²å½“éƒ¨åˆ†ã‚’å‚ç…§å½¢å¼ã«ç½®æ›
                processedMarkdown = processedMarkdown.replace(fullMatch, `![${altText}](${imageName})`);
                imageCount++;
            }
            
            // ç”»åƒãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateImageList();
            loadingIndicator.style.display = 'none';
            
            if (imageCount > 0) {
                console.log(`${imageCount}å€‹ã®ç”»åƒã‚’å‚ç…§ã‚·ã‚¹ãƒ†ãƒ ã«å¤‰æ›ã—ã¾ã—ãŸ`);
            }
            
            return processedMarkdown;
        }

        // ç”»åƒå‚ç…§ã®æŒ¿å…¥
        function insertImageReference(imageName) {
            const textarea = document.getElementById('markdown-input');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            const imageMarkdown = `![${imageName}](${imageName})`;
            
            textarea.value = textBefore + imageMarkdown + textAfter;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + imageMarkdown.length, cursorPos + imageMarkdown.length);
            checkForChanges();
        }

        // ç”»åƒã®å‰Šé™¤
        function removeImage(imageName) {
            if (confirm(`ç”»åƒ "${imageName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                imageStorage.delete(imageName);
                updateImageList();
                checkForChanges();
            }
        }

        // ã¯ã¦ãªè¨˜æ³•ã®å‡¦ç†
        function processHatenaSyntax(markdown) {
            // ç”»åƒå‚ç…§ã‚’Base64ãƒ‡ãƒ¼ã‚¿ã«ç½®æ›
            imageStorage.forEach((base64Data, imageName) => {
                const regex = new RegExp(`!\\[([^\\]]*)\\]\\(${imageName}\\)`, 'g');
                markdown = markdown.replace(regex, `![$1](${base64Data})`);
            });

            // [f:id:username:timestamp] å½¢å¼ã®ç”»åƒè¨˜æ³•
            markdown = markdown.replace(/\[f:id:([^:]+):([^\]]+)\]/g, (match, username, timestamp) => {
                const imageKey = `hatena_${username}_${timestamp}`;
                if (imageStorage.has(imageKey)) {
                    return `![${match}](${imageStorage.get(imageKey)})`;
                }
                return `<div class="hatena-syntax">ğŸ“· ã¯ã¦ãªç”»åƒ: ${match} (ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„)</div>`;
            });

            // [http://example.com:title] å½¢å¼ã®ãƒªãƒ³ã‚¯è¨˜æ³•
            markdown = markdown.replace(/\[(https?:\/\/[^\]]+):title\]/g, (match, url) => {
                return `[${url}](${url})`;
            });

            // [tex: æ•°å¼] è¨˜æ³•
            markdown = markdown.replace(/\[tex:\s*([^\]]+)\]/g, (match, formula) => {
                return `<div class="hatena-syntax">ğŸ“ æ•°å¼: ${formula}</div>`;
            });

            // [:contents] ç›®æ¬¡è¨˜æ³•
            markdown = markdown.replace(/\[:contents\]/g, '<div class="hatena-syntax">ğŸ“‹ ç›®æ¬¡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>');

            return markdown;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updatePreview() {
            const markdownText = document.getElementById('markdown-input').value;
            const processedMarkdown = processHatenaSyntax(markdownText);
            
            try {
                const html = marked.parse(processedMarkdown);
                const cleanHtml = DOMPurify.sanitize(html);
                document.getElementById('preview-content').innerHTML = cleanHtml;
                
                // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            } catch (error) {
                document.getElementById('preview-content').innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: \${error.message}</div>`;
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãï¼ˆè­¦å‘Šä»˜ãï¼‰
        function openFile() {
            if (hasUnsavedChanges) {
                if (!confirm('ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ãŒã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
            }
            document.getElementById('file-input').click();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆBase64ç”»åƒã®å¤‰æ›å‡¦ç†ã‚’è¿½åŠ ï¼‰
        function loadFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let content = e.target.result;
                    
                    // æ—¢å­˜ã®ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                    imageStorage.clear();
                    
                    // Base64ç”»åƒã‚’å‚ç…§ã‚·ã‚¹ãƒ†ãƒ ã«å¤‰æ›
                    content = convertBase64ImagesToReferences(content);
                    
                    document.getElementById('markdown-input').value = content;
                    initialContent = content;
                    updateSaveStatus(true);
                    updatePreview();
                };
                reader.readAsText(file);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒã‚‚å«ã‚ã¦å‡¦ç†ï¼‰
        function downloadMarkdown() {
            let content = document.getElementById('markdown-input').value;
            
            // ç”»åƒå‚ç…§ã‚’Base64ãƒ‡ãƒ¼ã‚¿ã«ç½®æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            imageStorage.forEach((base64Data, imageName) => {
                const regex = new RegExp(`!\\[([^\\]]*)\\]\\(${imageName}\\)`, 'g');
                content = content.replace(regex, `![$1](${base64Data})`);
            });
            
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã¯ä¿å­˜æ¸ˆã¿ã¨ã¿ãªã™
            initialContent = document.getElementById('markdown-input').value;
            updateSaveStatus(true);
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    const imageName = `image-${imageCounter++}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                    
                    imageStorage.set(imageName, imageUrl);
                    updateImageList();
                    
                    // è‡ªå‹•çš„ã«ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥
                    insertImageReference(imageName);
                };
                reader.readAsDataURL(file);
            }
        }

        // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¯ãƒªã‚¢
        function clearEditor() {
            let confirmMessage = 'ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ';
            if (hasUnsavedChanges) {
                confirmMessage = 'æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ';
            }
            
            if (confirm(confirmMessage)) {
                document.getElementById('markdown-input').value = '';
                document.getElementById('preview-content').innerHTML = '<div class="drag-drop-area"><p>ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p></div>';
                imageStorage.clear();
                updateImageList();
                initialContent = '';
                updateSaveStatus(true);
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        const dragDropArea = document.getElementById('preview-content');

        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropArea.classList.add('dragover');
        });

        dragDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
        });

        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        const imageName = `dropped-${imageCounter++}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                        
                        imageStorage.set(imageName, imageUrl);
                        updateImageList();
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æœ«å°¾ã«è¿½åŠ 
                        const textarea = document.getElementById('markdown-input');
                        const imageMarkdown = `\n![${file.name}](${imageName})\n`;
                        textarea.value += imageMarkdown;
                        textarea.focus();
                        checkForChanges();
                    };
                    reader.readAsDataURL(file);
                } else if (file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                    if (hasUnsavedChanges) {
                        if (!confirm('ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ãŒã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
                            return;
                        }
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let content = e.target.result;
                        
                        // æ—¢å­˜ã®ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                        imageStorage.clear();
                        
                        // Base64ç”»åƒã‚’å‚ç…§ã‚·ã‚¹ãƒ†ãƒ ã«å¤‰æ›
                        content = convertBase64ImagesToReferences(content);
                        
                        document.getElementById('markdown-input').value = content;
                        initialContent = content;
                        updateSaveStatus(true);
                        updatePreview();
                    };
                    reader.readAsText(file);
                }
            });
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'p':
                        e.preventDefault();
                        updatePreview();
                        break;
                    case 's':
                        e.preventDefault();
                        downloadMarkdown();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFile();
                        break;
                }
            }
        });

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å¤‰æ›´ç›£è¦–
        document.getElementById('markdown-input').addEventListener('input', () => {
            checkForChanges();
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(updatePreview, 1000);
        });

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            initialContent = document.getElementById('markdown-input').value;
            updatePreview();
            updateSaveStatus(true);
            updateImageList();
        });
    </script>
</body>
</html>